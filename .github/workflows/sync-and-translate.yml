name: Sync and Translate GeonicDB Docs

on:
  workflow_dispatch:
  repository_dispatch:
    types: [geonicdb-docs-updated]

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-and-translate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout geonicdb-docs
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Checkout geolonia/geonicdb (docs/ and CHANGELOG.md via sparse-checkout)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          repository: geolonia/geonicdb
          token: ${{ secrets.GEONICDB_PAT }}
          path: .geonicdb-upstream
          sparse-checkout: |
            docs
            CHANGELOG.md
          sparse-checkout-cone-mode: false

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Run sync-docs
        run: GEONICDB_REPO_PATH=.geonicdb-upstream pnpm run sync-docs

      - name: Detect changed files
        id: detect
        run: |
          # sync-docs writes Japanese content into docs/ja/ paths
          # Check for any .md file changes in docs/ (includes both docs/ja/ and docs/en/)
          CHANGED=$(git diff --name-only -- 'docs/' | grep '\.md$' || true)
          UNTRACKED=$(git ls-files --others --exclude-standard -- 'docs/' | grep '\.md$' || true)
          ALL_CHANGED=$(echo -e "${CHANGED}\n${UNTRACKED}" | sort -u | grep -v '^$' || true)

          if [ -z "$ALL_CHANGED" ]; then
            echo "No documentation changes detected"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changed files:"
            echo "$ALL_CHANGED"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "$ALL_CHANGED" > /tmp/changed_files.txt
            # Build file list for PR body
            {
              echo "file_list<<EOF"
              echo "$ALL_CHANGED"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Verify yuuhitsu is available
        if: steps.detect.outputs.has_changes == 'true'
        run: |
          if ! npx yuuhitsu --help > /dev/null 2>&1; then
            echo "::error::yuuhitsu CLI is not available. Check installation."
            exit 1
          fi
          echo "yuuhitsu CLI is available"

      - name: Translate changed files
        if: steps.detect.outputs.has_changes == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # sync-docs puts Japanese content into docs/ja/ paths.
          # Translate each changed ja file from Japanese to English, output to docs/en/.
          JA_FILES=$(grep '^docs/ja/' /tmp/changed_files.txt || true)
          if [ -z "$JA_FILES" ]; then
            echo "No docs/ja/ files to translate"
            exit 0
          fi
          TOTAL=$(echo "$JA_FILES" | wc -l)
          FAILED=0
          echo "Translating $TOTAL files..."
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              en_file="${file/docs\/ja\//docs\/en\/}"
              echo "Translating: $file -> $en_file"
              mkdir -p "$(dirname "$en_file")"
              if ! npx yuuhitsu translate --input "$file" --lang en --output "$en_file"; then
                echo "::error::Failed to translate $file"
                FAILED=$((FAILED + 1))
              fi
            fi
          done <<< "$JA_FILES"
          if [ "$FAILED" -gt 0 ]; then
            echo "::error::$FAILED/$TOTAL translations failed"
            exit 1
          fi
          echo "All $TOTAL files translated successfully"

      - name: Post-translation quality fixes (docs/ja/ and docs/en/)
        if: steps.detect.outputs.has_changes == 'true'
        run: npx tsx scripts/fix-doc-quality.ts

      - name: Glossary compliance check
        if: steps.detect.outputs.has_changes == 'true'
        run: |
          # Check all ja docs after translation
          FAILED=0
          TOTAL=0
          while IFS= read -r -d '' f; do
            TOTAL=$((TOTAL + 1))
            echo "Checking: $f"
            if ! npx --yes @geolonia/yuuhitsu glossary check \
                --input "$f" \
                --glossary glossary.yaml \
                --lang ja; then
              echo "::warning file=$f::Glossary violation detected"
              FAILED=$((FAILED + 1))
            fi
          done < <(find docs/ja -name "*.md" -print0)
          echo "Glossary compliance check: $FAILED/$TOTAL files have violations"
          if [ "$FAILED" -gt 0 ]; then
            exit 1
          fi

      - name: Build verification
        if: steps.detect.outputs.has_changes == 'true'
        run: pnpm docs:build

      - name: Create Pull Request
        if: steps.detect.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@22a9089034f40e5a961c8808d113e2c98fb63676 # v7
        with:
          token: ${{ secrets.DOCS_WRITE_PAT }}
          commit-message: "docs: sync and translate from geonicdb/docs (${{ github.event.client_payload.sha || 'manual' }})"
          title: "docs: sync and translate from geonicdb/docs"
          body: |
            ## Automated Sync & Translation

            **Trigger**: ${{ github.event_name }}
            **GeonicDB SHA**: ${{ github.event.client_payload.sha || 'N/A (manual dispatch)' }}

            ### Changed files
            ${{ steps.detect.outputs.file_list }}

            ### Process
            1. Synced docs from geolonia/geonicdb
            2. Translated changed Japanese docs to English via yuuhitsu
            3. Build verification passed
          branch: docs/auto-sync-translate
          base: main
          labels: documentation,automated
